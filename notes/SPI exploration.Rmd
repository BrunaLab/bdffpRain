---
title: "Figuring out Standardized Precipitation Index calculation"
author: "Eric R. Scott"
date: "2020-06-23"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(SPEI)
library(tsibble) #for viewing timeseries output of SPEI better.
library(MASS)

select <- dplyr::select
```

*Last compiled: `r Sys.Date()`*

# TODO:

- Do I need to transform data to normal-ish?
- Use Pearson III distribution instead of Gamma?
- Read other resources here: http://www.ncl.ucar.edu/Applications/spi.shtml

# Purpose

Figure out how to calculate Standardized Precipitation Index *sensu* McKee, T.B., Doesken, N.J. & Kleist, J. (1993) The relationship of drought frequency and duration to time scales. Proceedings of the 8th Conference on Applied Climatology, 17, 179–183.

There exists a package, `spi`, that claims to have implemented this, but it is not coded well and barely usable.  Also, I think it might be wrong.  I'm not going to use it.

I'll try comparing my calculations with the `SPEI` package.

# General idea

The general idea of Standardized Precipitation Index is to fit a distribution to precipitation (or standardized precipitation) to get probabilities, then back-transform those probabilities with an inverse Gaussian to get things in terms of standard deviations.  Those standard deviation units are the Standardized Precipitation Index (SPI).

Most people seem to agree that either a Gamma distribution or a Pearson III distribution should be used to fit the data.  What seems really inconsistent is *what data*.  The original source (McKee et al. 1993) seems to suggest using a windowed average (3, 6, 12, or 24 months) and then standardizing precip using the past period.  Other sources seem to suggest the windowed average, but over *all years*.  Others seem to just use raw precip data (which seems wrong).

# Manaus

I'll use the Manaus dataset and aggregate monthly.  I'll convert to timeseries with the `tsibble` package.

```{r data, echo=TRUE}
manaus <- read_csv(here("data_cleaned", "manaus_weather.csv"))
manaus_ts <- manaus %>% as_tsibble(index = date)
```
There are two NAs in the data, which for now I will just ignore when I aggregate.
```{r}
which(is.na(manaus_ts$precip))
```


# Aggregate monthly

```{r}
manaus_mon <-
  manaus_ts %>% 
  index_by(year_month = yearmonth(date)) %>% 
  summarize(precip = sum(precip, na.rm = TRUE))
```

# Analysis with SPEI pacakge

Calculate SPI with a 3-month window.

Using defaults seems like the best idea.

```{r}
spi(manaus_mon$precip, scale = 6) -> out

out$fitted %>% as_tsibble()
plot(out)
```

I guess I can just ignore the index and add a column to the manaus data?
```{r}
manaus_spi <- manaus_mon %>% add_column(spi = as_tsibble(out$fitted)$value)
```

```{r}
manaus_spi <-
  manaus_spi %>% 
  mutate(category = case_when(
    spi <= -2.00 ~ "extreme",
    spi <= -1.5 & spi > -2 ~ "severe",
    spi <= -1 & spi > -1.5 ~ "moderate",
    spi <= 0 & spi > -1 ~ "mild"
  )) %>% 
  mutate(category = fct_relevel(category, "mild", "moderate", "severe", "extreme"))

ggplot(manaus_spi, aes(x = year_month, y = spi)) +
  geom_line(aes(color = category, group = 1)) +
  scale_x_yearmonth("Date") +
  scale_y_continuous("SPI") +
  scale_color_ordinal("Drought\ncategory", option = "C", na.value = "darkgrey", end = 0.9) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "SPI with 12 month window for Manaus station")
```
NICE!

# GPCC data

Now let's see if I can do the same thing for the gridded data

```{r}
gpcc <- read_csv(here("data_cleaned", "gpcc_mon_tot_0.5x0.5.csv"))
gpcc_l <- gpcc %>% group_by(lat, lon) %>% group_split()
```
```{r}
names(gpcc_l) <- map(gpcc_l, ~ as.character(paste(first(.x$lat), first(.x$lon))))
gpcc_spi <-
  map_df(gpcc_l, ~{
  out <- spi(.x$precip, 12)
  spi <- as_tsibble(out$fitted)
  add_column(.x, spi = spi$value)
}, .id = "gridcell")
```

# Visualize

```{r}
gpcc_spi <-
  gpcc_spi %>% 
  #categories from McKee et al.
  mutate(category = case_when(
    spi <= -2.00 ~ "extreme",
    spi <= -1.5 & spi > -2 ~ "severe",
    spi <= -1 & spi > -1.5 ~ "moderate",
    spi <= 0 & spi > -1 ~ "mild"
  )) %>% 
  mutate(category = fct_relevel(category, "mild", "moderate", "severe", "extreme")) %>% 
  mutate(lat_lab = sp::dd2dms(lat, NS = TRUE) %>% str_replace("d", "º"),
         lon_lab = sp::dd2dms(lon-360) %>% str_replace("d", "º")) %>% 
  mutate(lat_lab = fct_relevel(lat_lab, "2º15'S", "2º45'S"),
         lon_lab = as_factor(lon_lab))

ggplot(gpcc_spi, aes(x = date, y = spi)) +
  geom_line(aes(color = category, group = 1)) +
  facet_grid(lat_lab~lon_lab) +
  scale_x_yearmonth("Date") +
  scale_y_continuous("SPI") +
  scale_color_ordinal("Drought\ncategory", option = "C", na.value = "darkgrey", end = 0.9) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "SPI with 12 month window for area encompasing BDFFP")
```




# Notes from McKee et al

## Prepare data

>"A monthly precipitation data set is prepared for a period of *m* months... A set of averaging periods are selected to determine a set of time scales of period *i* months where *i* is 3, 6, 12, 24, or 48 months" 

I'll be using 3 months.

>"The data set is moving in the sense that each month a new value is determined from the previous *i* months."


>"Standardized precipitation is simply the difference of precipitation from the mean for a specified time period divided by the standard deviation where the mean and standard deviation are determined from past records."

So this sounds like a rolling average, but according to [another source](https://www.in.gov/dnr/water/4864.htm), it might mean the average of that 3-month period from all *previous years*:

>"The 3-month SPI provides a comparison of the precipitation over a specific 3-month period with the precipitation totals from the same 3-month period for all the years included in the historical record. In other words, a 3-month SPI at the end of February compares the December-January-February precipitation total in that particular year with the December-February precipitation totals of all the years. A 3-month SPI reflects short- and medium-term moisture conditions and provides a seasonal estimation of precipitation."

This is fewer data points on which to fit a distribution

```{r}
#TODO change to be rolling 3-month average but over all years?
wichita1 <- 
  wichita %>%
  mutate(lag1 = lag(PRCP),
         lag2 = lag(PRCP, 2),
         lag3 = lag(PRCP, 3)) %>% 
  rowwise() %>% 
  mutate(mean_prev = mean(c(lag1, lag2, lag3)),
         sd_prev = sd(c(lag1, lag2, lag3)),
         sp = PRCP - mean_prev / sd_prev) %>% 
  filter(!is.na(sp))
wichita1
```
Ok, I'm not understanding something correctly because this results in some negative values, which are not allowed in a Gamma distribution. 

## Fit to Gamma function

>"Each of the data sets [one per value of *i*] are fitted to the Gamma function to define the relationship of probability to precipitation."

- `MASS::fitdistr(x, densfun)` fits data to distributions with maximum likelihood and returns coefficients of a function (shape and rate) with standard errors

Guttman et al. 1999 suggest using a Pearson III distribution instead.  Not sure how to fit that in R yet.  The Pearson III might only be better if the site has a lot of months with 0 rainfall.

```{r}
x <- fitdistr(wichita1$sp, densfun = "gamma")
coef(x)
```

>"Once the relationship of probability to precipitation is established from the historic records, the probability of any observed precipitation data point is calculated ..."

```{r}
spi_tidy2 <- spi_tidy %>% 
  mutate(precip_p = pgamma(precip, shape = coef(x)[1], rate = coef(x)[2]))
spi_tidy2
```

## Convert probabilities to SPI

>"...and used along with an estimate of the inverse normal to calculate the precipitation deviation for a normally distributed probability density with a mean of zero and a standard deviation of unity."

```{r}
spi_final <-
  spi_tidy2 %>% 
  mutate(spi = qnorm(precip_p))
spi_final
```
