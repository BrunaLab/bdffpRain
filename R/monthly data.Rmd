---
title: "Monthly Totals"
author: "Eric R. Scott"
date: "2020-07-15"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lubridate)
library(tsibble)
library(SPEI)
library(corrr)
library(naniar)

source(here("R", "utils.R"))
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
```

*Last compiled: `r Sys.Date()`*
# TODO:

- check that date range is correct for `bdffp_wide`
- check missingness of bdffp composite (with and without spreading accumulations back)

# Purpose

Aggregate monthly total rainfall at BDFFP sites using some method to interpolate/impute gaps.  Compare with using continuous data for calculating SPI.

# Load Data

```{r data, echo=TRUE, message=FALSE, warning=FALSE}
bdffp <- read_csv(here("data_cleaned", "daily_precip.csv"))
bdffp_ts <- as_tsibble(bdffp, key = site, index = date) %>% fill_gaps()
gpcc <- read_csv(here("data_cleaned", "gpcc_mon_tot_0.5x0.5.csv"))
gpcc_ts <- as_tsibble(gpcc, index = date, key = c (lat, lon))
manaus <- read_csv(here("data_cleaned", "manaus_weather.csv"))
manaus_ts <- manaus %>% as_tsibble(index = date)
```

# Notes from Meeting with Emilio

Fill in missing *days*, then aggregate monthly to keep more data and more
potential variation among sites (as opposed to NOAA method that fills in missing
*months* after aggregation)

chunking/combining sites by camp

1. dimona (less Heliconia, more Monotagma)
2. Porto alegre
3. Colosso, florestal, cabo frio
4. km37 km41

Maybe even combine 3 & 4

Does difference between dimona and km41 even matter?  E.g. is SPI category different often?

0. Just get monthly means with `na.rm = TRUE` and see if SPI is different across sites at BDFFP and compared with GPCC data. (Manaus vs GPCC vs BDFFP pooled vs. BDDP grouped (dimona vs porto alegre vs. colosso cluster vs 37/41)

1. Using the 4 most used sites (colosso, km41, dimona, porto alegre) create a monthly dataset
  a. Include accumulated observations after gaps less than, say, 5 days
  b. For longer gaps, spread accumulation up to 5 days behind, then fill in remaining NAs using some rules:
    i. with data from closest site(s), or...
    ii. with data from bdffp average for that day, or...
    iii. with average for that day from last 3 (?) years, or...
    iV. with GPCC data for closest grid cell
  c. Alternatively, fill in missing days using a regression method like described by the NOAA paper.
2. Calculate SPI
3. Look at concordance of SPI values and categories across 4 sites.
4. Do a sensitivity analysis 
  a. change threshold gap size for ignoring accumulated observations
  b. change rules for filling in NAs
  c. compare to assumption that NAs are zeroes (i.e. just skipping 1b.)
5. If no differences across camps (or no ability to detect differences)...
  a. Average monthly precip across all BDFFP sites (?)
  a. compare SPI calculated with BDFFP average to GPCC gridded data and station data (Manaus)
  b. is it worth it to go through step 1, or better to just use GPCC data?

# Reference SPI

Get SPI calculations for GPCC data and Manaus for comparisons

```{r}
#set scale (in months) for consistency
spi_scale <- 3
```

Use only the two grid cells that cover BDFFP

```{r}
gpcc_mon <-
  gpcc_ts %>%
  filter(lat == -2.25, lon %in% c(299.75, 300.25)) %>% 
  mutate(site = ifelse(lon == 299.75, "gpcc_west", "gpcc_east")) %>% 
  index_by(yearmonth = yearmonth(date)) %>% 
  group_by(site) %>% 
  summarize(tot_precip = sum(precip),
            percent_complete = 100)

```

```{r}
manaus_mon <-
  manaus_ts %>% 
  fill_gaps() %>% #no gaps, but just in case
  index_by(yearmonth = yearmonth(date)) %>% 
  summarize(site = "manaus",
            tot_precip = sum(precip, na.rm = TRUE), #only two NAs in manaus data
            percent_complete = 100)
```

Combine GPCC and Manaus continuous data

```{r}
ref_mon <- bind_rows(gpcc_mon, manaus_mon)
# class(ref_mon)
```

Calculate SPI for all sites

```{r}
ref_spi <- 
  ref_mon %>% 
  group_by(site) %>% 
  mutate(spi = spi(tot_precip, scale = spi_scale)$fitted %>% as.numeric()) %>% 
  filter(!is.na(spi)) %>% 
  mutate(category = case_when(
    spi <= -2.00 ~ "extreme",
    spi <= -1.5 & spi > -2 ~ "severe",
    spi <= -1 & spi > -1.5 ~ "moderate",
    spi <= 0 & spi > -1 ~ "mild",
    TRUE ~ "no drought"
  )) %>% 
  ungroup() %>% 
  mutate(category = fct_relevel(category, "no drought", "mild", "moderate", "severe", "extreme"))
ref_spi %>% as_tibble() %>% count(category, site)
```
8-14 extreme drought events in reference data

# Quick and dirty aggregation

## Spread accumulations across month borders

I'll simply "spread" any observations after NAs backwards by up to 7 days

```{r}
bdffp_ts2 <-
  bdffp_ts %>%
  group_by(site) %>%
  mutate(precip = spread_back(precip, max_n = 7))

#or skip spreading step:
# bdffp_ts2 <- bdffp_ts
```

How does that affect mean monthly totals?

```{r}
mon_tot_raw <-
  bdffp_ts %>% 
  index_by(yearmonth = yearmonth(date)) %>% 
  group_by(site) %>% 
  summarize(precip = sum(precip, na.rm = TRUE)) %>% 
  as_tibble()

```
```{r}
mon_tot_spread <- 
  bdffp_ts2 %>% 
  index_by(yearmonth = yearmonth(date)) %>% 
  group_by(site) %>% 
  summarize(precip = sum(precip, na.rm = TRUE)) %>% 
  as_tibble()
  
```

```{r}
full_join(mon_tot_raw, mon_tot_spread, by = c("site", "yearmonth")) %>% 
  mutate(year = year(yearmonth), month = month(yearmonth, label = TRUE)) %>% 
  group_by(site, year) %>% 
  summarize(cor = cor(precip.x, precip.y, method = "spearman")) %>% 
  arrange(cor)
```

Most of the time it has minimal effects, but in some years/months/sites, spreading accumulations across month borders has a larger effect.

## Group Sites

Create a BDFFP average column that produces a single average precip across all sites.

```{r}
bdffp_wide <-
  bdffp_ts2 %>% 
  select(site, date, precip) %>% 
  pivot_wider(names_from = site, values_from = precip)
bdffp_wide$bdffp <- rowMeans(bdffp_wide[2:9], na.rm = TRUE)
#replace NaN with zero (note this is WRONG)
# bdffp_wide$bdffp[is.nan(bdffp_wide$bdffp)] <- 0
```

Create 2 "cluster" sites that are averages of nearby and geographically distinct sites.


3. Colosso, florestal, cabo frio
4. km37 km41

```{r}
bdffp_wide <- 
  bdffp_wide %>% 
  rowwise() %>% 
  mutate(colosso_cluster = mean(c(colosso, florestal, `cabo frio`), 
                                na.rm = TRUE),
         km_cluster = mean(c(km37, km41), na.rm = TRUE)) %>% 
  #replace NaNs with 0.  Note this is wrong!
  mutate(across(matches("colosso_cluster") | matches("km_cluster"),
                ~if_else(is.nan(.), 0, .))) %>% 
  ungroup()
```

```{r}
bdffp_ts3 <-
  bdffp_wide %>% 
  pivot_longer(!matches("date"), names_to = "site", values_to = "precip") %>% 
  as_tsibble(index = date, key = site)
```

## Visualize missingness

```{r}
vis_miss(bdffp_wide)
```
bdffp composite has 0% missing?

Just aggregate monthly with na.rm = TRUE. This is **definitely** wrong!

```{r}
bdffp_mon <-
  bdffp_ts3 %>%
  index_by(yearmonth = yearmonth(date)) %>%
  filter(
    site %in% c( # 4most used sites + cluster + site average
      "colosso",
      "dimona",
      "km41",
      "porto alegre",
      "bdffp",
      "colosso_cluster",
      "km_cluster"
    )
  ) %>% 
  group_by(site) %>%
  summarize(
    tot_precip = sum(precip, na.rm = TRUE),
    percent_complete = sum(!is.na(precip)) / n() * 100
  ) %>%
  mutate(tot_precip = ifelse(percent_complete == 0,
                                 NA,
                                 tot_precip)) %>%
  #just replace na's with zeroes.  SUPER WRONG
  mutate(tot_precip = replace_na(tot_precip, 0))

```



Use (incorrectly) aggregated data to calculate SPI at all sites and clusters of sites.

```{r}
bdffp_spi <- 
  bdffp_mon %>% 
  group_by(site) %>% 
  mutate(spi = spi(tot_precip, scale = spi_scale)$fitted %>% as.numeric()) %>% 
  filter(!is.na(spi)) %>% 
  mutate(category = case_when(
    spi <= -2.00 ~ "extreme",
    spi <= -1.5 & spi > -2 ~ "severe",
    spi <= -1 & spi > -1.5 ~ "moderate",
    spi <= 0 & spi > -1 ~ "mild",
    TRUE ~ "no drought"
  )) %>%
  ungroup() %>% 
  mutate(category = fct_relevel(category, "no drought", "mild", "moderate", "severe", "extreme")) %>% 
  filter(!is.na(category))
```

No extreme droughts? Possibly because relatively more (artifactual) zeroes, so "dry" is more normal.

## SPI Correlation among data sources

Join with reference

```{r}
all_spi <- bind_rows(bdffp_spi, ref_spi) %>% as_tibble()
```


### SPI values

```{r}
all_spi %>%
  select(yearmonth, site, spi) %>% 
  pivot_wider(names_from = site, values_from = spi) %>% 
  select(-yearmonth) %>% 
  correlate(method = "spearman") %>% 
  rearrange(method = "HC") %>% 
  shave() %>% 
  rplot(print_cor = TRUE) +
  theme(axis.text.x = element_text(angle =45, hjust = 1)) +
  scale_color_viridis_c("spearman rho") +
  labs(title = "Correlations for monthly SPI values")
```


km41 is the most complete dataset, and it's in the east part of the site, but has really low correlation with the GPCC grid

porto alegre is most strongly correlated with the across bdffp average, probably just because it has a relatively complete dataset?

### SPI Categories

How about the SPI categories?


```{r}
all_spi%>% 
  select(yearmonth, site, category) %>% 
  mutate(category = as.numeric(category)) %>% 
  pivot_wider(names_from = site, values_from = category) %>% 
  select(-yearmonth) %>% 
  correlate(method = "spearman") %>% 
  rearrange(method = "HC") %>% 
  shave() %>% 
  rplot(print_cor = TRUE) +
  theme(axis.text.x = element_text(angle =45, hjust = 1)) +
  scale_color_viridis_c("spearman rho") +
  labs(title = "Correlations for monthly SPI categories")
```
```{r}
all_spi %>% count(site, category)
```

Looking at drought categories, they are also not well correlated among sites or between individual sites and continuous data.
