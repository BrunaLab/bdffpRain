---
title: "Wrangling Precipitation Data"
author: "Eric R. Scott"
date: "2020-06-24"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(readxl)
library(lubridate)
library(janitor)
library(hms)
library(tsibble)
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Reading and wrangling precip data

# Reading and parsing data

The HORA column is sometimes formatted as text and sometimes as time.  Read in both ways and join.

```{r data, echo=TRUE}
sites <- list.files(here("data_raw", "rain"))
names(sites) <- str_remove(sites, "\\..+$")

all_raw <- map_df(sites, ~{
  site <- .x
  sheets <- excel_sheets(here("data_raw", "rain", site))
  sheets <- sheets[str_detect(sheets, "\\d{4}")]

  site_raw <-
    map_df(sheets, ~ read_excel(
      here("data_raw", "rain", site),
      sheet = .x,
      range = cell_limits(c(3,1), c(NA, 6)),
      col_types = c("date", "numeric", "text", "numeric", "text", "text")
    ))

time_as_date <-
  map_df(sheets, ~ suppressWarnings(read_excel(
    here("data_raw", "rain", site),
    sheet = .x,
    range = cell_limits(c(3,1), c(NA, 6)),
    col_types = c("date", "numeric", "text", "numeric", "date", "text")
  )))

site_raw <- site_raw %>% add_column(time_as_date = time_as_date$HORA)
},
.id = "site")
sample_n(all_raw, 7)
```

## Data Dictionary

There are 8 sites, each with a .xls spreadsheet with multiple tabs.  Each tab contains data from 3 years and the last two tabs have some aggregated data done in Excel.

- `DATA`: Date
- `CHUVA`: Rainfall in mm (?)
- `OBSERVADOR`: the name of the person who recorded the data
- `DIA`: day of year
- `HORA`: time of collection in 24-hr time  (sometimes as text, sometimes as time)
- `COMENTARIO`: notes.  For example, whether the data was aggregated over previous days because no one was around to check the gauge.



# Cleaning

## Basics

- Remove missing rows
- Make column headings lowercase
- combine columns that are just typos (comentario and commentario)

```{r}
all <-
  all_raw %>% 
  clean_names() %>% 
  mutate(comentario = ifelse(is.na(comentario), commentario, comentario),
         data = as_date(data)) %>% 
  select(-commentario)
all

#fix typo in date column
all %>% add_rownames() %>% filter(is.na(data) & !is.na(chuva))
all$data[6646] <- ymd("2000-03-31")

#remove missing rows
all <- all %>% filter(!is.na(data))
```


## Quality Control

### Check that there are no missing dates

This shows any problems with dates by checking the data against a sequence from earliest to latest date by day.

- the missing dates in COLOSSO are typos

```{r}
x <- all %>% 
  group_by(site) %>% 
  summarize(start = min(data),
            end = max(data))
out <- list()
for (i in 1:nrow(x)) {
  out[[i]] <- tibble(date = seq(x$start[i], x$end[i], by = "days"))
}
names(out) <- x$site
tester <- bind_rows(out, .id = "site")

missing_dates <- anti_join(tester, all, by = c("site" = "site", "date" = "data")) 

missing_dates %>% 
  group_by(site) %>% 
  summarize(number_missing = n(),
            min = min(date),
            max = max(date))

# missing_dates %>% filter(site %in% c("41dia", "COLOSSO"))
```

- Check that `DIA` matches day of year calculated from date.

```{r}
all %>% 
  mutate(doy = yday(data)) %>% 
  #show only rows where the calculated DOY doesn't match the entered DOY
  filter(dia != doy) %>% 
  group_by(site) %>% 
  summarize(n = n(),
            start = min(data),
            end = max(data))
```
A few are (probably) typos,  CABO, DIMONA, and GAVIAO are off by one day for large sections, and I don't know what is going on in PORTO.  This column should be trashed and replaced by `yday(date)`.

```{r}
all <-
  all %>% 
  mutate(dia = yday(data))
```


### Check times

For the HORA column in Excel, sometimes the entry is character and sometimes it is a time.  When `read_excel` uses "text", then the character entries read in correctly, but the time entries read in as a weird decimal number.  When `read_excel()` uses "date", then the character entries read in as `<NA>` and the time entries read in as the correct time, but on the date 1899-12-31. There are also some text entries of time that include notes, for example, "7:00    chuva noite<0,1", or are entirely notes, e.g. "nao foi feita observ". 

1. Extract notes and times separately from the `hora` column.
2. Convert the `hora` column to time (as HH:MM)
3. Extract any notes written in the time column and merge with other notes.


```{r}
all_2 <-
  all %>% 
  mutate(time_notes = str_remove(hora, "\\d{1,2}:\\d{2}"), #everything except times
         hora = str_replace(hora, "(?<=\\d{1,2});(?=\\d{2})", ":"), #fix semi-colon typos
         time_from_text = as_datetime(parse_hm(str_extract(hora, "\\d{1,2}:\\d{2}")))) %>% #convert to time
  mutate(time_notes = ifelse(!is.na(time_as_date), NA, time_notes), #get rid of notes that shouldn't be there
         time_notes = na_if(time_notes, "")) %>% 
  #merge two dates and format as HH:MM
  mutate(time = as_datetime(ifelse(!is.na(time_as_date), time_as_date, time_from_text)),
         time = format(time, "%R"))
```

Check that you got them all by comparing original data read in both ways to new time column and look for NAs.

```{r}
all_2 %>% 
  filter(!is.na(hora) & is.na(time))
```

**manually fix these errors??**

### Consolidate comments

```{r}
all_clean <-
  all_2 %>% 
  unite(notes, c(time_notes, comentario), na.rm = TRUE, sep = "; ") %>% 
  mutate(notes = na_if(notes, ""))
all_clean
```

### Translate

Translate column names to English

```{r}
all_clean2 <-
  all_clean %>% 
  select(site, date = data, doy = dia, time, observer = observador, precip = chuva, notes)
```
```{r}
all_clean2 %>% skimr::skim()
unique(all_clean2$notes)
```


# Check for problems

add rownumbers to facilitate manual data fixing

```{r}
all_clean2 <- all_clean2 %>% add_rownames()
```

## Problems in precip

The value for DIMONA 2005-02-22 is not correct.  It got converted to a date by Excel.  Dr. Bruna did some investigating and the correct value is 53

```{r}
all_clean2 %>% filter(precip < 0)
all_clean2 %>% filter(precip > 500)
#typo in Dimona
all_clean2 <- all_clean2 %>% mutate(precip = replace(precip, rowname == 27450, 53))
```
## Problems with dates

Check if dates are in order and if any are missing:

```{r}
#Dates not in order
all_clean2 %>% 
  add_rownames() %>% 
  group_by(site) %>% 
  filter(date != lag(date) + 1 & !is.na(lag(date)))
```

### Just implicit missing data:

```{r, eval=FALSE}
all_clean2 %>%
  slice(6512:6515)

all_clean2 %>% 
  slice(29980:29984)

all_clean2 %>% 
  slice(30073:30078)

all_clean2 %>% 
  slice(30469:30473)

all_clean2 %>% 
  slice(36710:36715)

all_clean2 %>% 
  slice(38200:38206)
```

### Typos That need fixing

Typos in date

```{r}
all_clean2 %>% 
  slice(12572:12576)

all_clean2 %>% 
  slice(32249:32253)

all_clean2 %>% 
  slice(39059:39066)

all_clean2 %>% 
  slice(38617:38622)

typos <- c("12574" = ymd("1988-10-01"),
           "32252" = ymd("1992-10-14"),
           "39062" = ymd("1994-01-05"),
           "39064" = ymd("1994-01-07"),
           "38620" = ymd("1992-10-20"))

all_clean2 <- 
  all_clean2 %>% 
  mutate(date = replace(date, rowname %in% as.numeric(names(typos)), typos))
```

Duplicated and empty dates

```{r}
all_clean2 %>% 
  slice(10530:10536)
#duplicated dec 1

all_clean2 <- all_clean2 %>% filter(rowname != 10533)
```

## Duplicated dates

These must be dealt with somehow

```{r}
duplicates(all_clean2, key = site, index = date)
```

# Flags and notes

I think it would be useful to create a `flag` column using the information in the notes.  I should research if there are some standards for how to do this already (like, what letters to use).  There are also some notes that relate to data directly possibly.

## Creating flags

Flags:

- `A`: tagged accumulation
- `E`: data error
- `T`: trace precipitation

```{r}
notes <- all_clean2$notes %>% unique()
notes
```
```{r}
all_clean2 <- 
  all_clean2 %>% 
  mutate(flag = case_when(
    str_detect(notes, "(A|a|√Å)c{1,2}umu") ~ "accumulated",
    str_detect(notes, "(P|p)luviometro no ch") ~ "error",
    str_detect(notes, "errada") ~ "error",
    str_detect(notes, "chuva noite<0,1") ~ "trace",
    TRUE ~ NA_character_
  ))
```


## Explicit NAs entered as 0

Some observations have 0 entered for precip, but "nao foi feita observ" (no observation made) entered in notes.

```{r}
# all_clean2 %>% filter(notes == "nao foi feita observ")
all_clean2 <-
  all_clean2 %>% 
  mutate(precip = replace(precip, str_detect(notes, "nao foi feita observ"), NA))
```


# Write to file

```{r}
#remove rowname
out <- all_clean2 %>% select(-rowname)
write_csv(out, here("data_cleaned", "daily_precip.csv"))
```
