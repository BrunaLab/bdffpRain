---
title: "Analysis Title"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

**TODO:**

- are grid cells centered on lat-lon values?  If so, I probably need fewer grid cells. ( I think i only need two cells:  2º15'S 60º15'W for Dimona, and 2º15'S 59º45'W for all other sites)
- Explore usefulness of statistical downscaling of gridded data using the [rainfarmr](https://github.com/jhardenberg/rainfarmr) package

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
library(ncdf4)
library(raster)
library(lubridate)
```

*Last compiled: `r Sys.Date()`*

# Getting GPCC gridded data

Here's how to download 1 year of data for the whole world

Starts at year 1891 goest through 2016

```{r}
u <- "https://psl.noaa.gov/thredds/dodsC/Datasets/gpcc/full_v2018/precip.mon.total.v2018.nc"
```

```{r}
plot(raster(u, varname = "precip", band = 1)) #plots first month of dataset
```
# Just BDFFP

```{r}
gpcc <- nc_open(u)

names(gpcc$var)
names(gpcc$dim)

lat <- ncvar_get(gpcc, "lat")
lon <- ncvar_get(gpcc, "lon")
time <- ncvar_get(gpcc, "time") #"days since 1800-1-1 00:00:00"

time <- as_date(time, origin = ymd("1800-01-01"))
```


I want to restrict this to a lat-lon near BDFFP and time that we have data for BDFFP

Lower-left corner = 02º30'00"S; 60º10'00"W
Upper-right corner = 02º15'00"S; 59º35'00"W

Need to convert to decimal degrees
https://www.rapidtables.com/convert/number/degrees-minutes-seconds-to-degrees.html

lat = -2.25º to -2.5º
lon = -59.583º to -60.167º OR 300.417 to 299.833

```{r}
# or with sp package
# sp::char2dms("02d30'S") %>% as.numeric()
```


```{r}
lat_min = -2.25
lat_max = -2.5
lon_min = -60.167
lon_max = -59.583


lat_min_i <- which.min(abs(lat - lat_min))
lat_max_i <- lat_min_i + 1
lon_min_i <- which.min(abs(lon - (360 + lon_min)))
lon_max_i <- which.min(abs(lon - (360 + lon_max))) + 1

lon[lon_min_i:lon_max_i]

lat[lat_min_i:lat_max_i]

# one month
precip <- ncvar_get(gpcc, "precip",
                    start = c(lon_min_i, lat_min_i, 1161), # c(lon, lat, time)
                    count = c(lon_max_i - lon_min_i + 1, lat_max_i - lat_min_i + 1, 1)  # c(lon, lat, time)
                    ) 
precip
```

rows are lon, columns are lat
lon 600, lat 185 = 172.99


Cool, now I want it over a specific time period

BDFFP data runs from 1987-09-01 to 2012-12-31

```{r}
tstart_i <- which(time == ymd("1987-09-01"))
tend_i <- which(time == ymd("2013-02-01"))

precip <- ncvar_get(gpcc, "precip",
                    start = c(lon_min_i, lat_min_i, tstart_i), # c(lon, lat, time)
                    count = c(lon_max_i - lon_min_i+1, lat_max_i - lat_min_i+1, tend_i - tstart_i+1)  # c(lon, lat, time)
                    ) 
precip[,,1]
```
precip[lon, lat, time]

# Convert into tidy format

Need to smoosh this array into a tidy dataframe with columns `lat`, `lon`, `date`, and `precip`.  I think.


```{r}
dimnames(precip) <- list(lon[lon_min_i:lon_max_i],
                         lat[lat_min_i:lat_max_i], 
                         as.character(time[tstart_i:tend_i]))

out <- 
  precip %>%
  as_tibble(rownames = "lon") %>% 
  pivot_longer(-lon, names_to = "lat", values_to = "precip") %>% 
  separate(lat, into = c("lat", "date"), sep = "\\.(?=\\d{4}-\\d{2}-\\d{2}$)") %>% 
  mutate(lon = as.numeric(lon), lat = as.numeric(lat), date = ymd(date)) %>% 
  select(date, lat, lon, precip) %>% 
  arrange(date)
out
```

```{r}
write_csv(out, here("data_cleaned", "gpcc_mon_tot_0.5x0.5.csv"))
```


```{r}
nc_close(gpcc)
```

