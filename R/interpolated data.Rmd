---
title: "Analysis Title"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
conflict_prefer("filter", "dplyr")

library(ncdf4)
library(raster)
```

*Last compiled: `r Sys.Date()`*

# Getting GPCC gridded data

Here's how to download 1 year of data for the whole world

Starts at year 1891 goest through 2016

```{r}
u <- "https://psl.noaa.gov/thredds/dodsC/Datasets/gpcc/full_v2018/precip.mon.total.v2018.nc"
```

```{r}
plot(raster(u, varname = "precip", band = 1)) #plots first month of dataset
```
# Just BDFFP

```{r}
gpcc <- nc_open(u)

names(gpcc$var)
names(gpcc$dim)

lat <- ncvar_get(gpcc, "lat")
lon <- ncvar_get(gpcc, "lon")
time <- ncvar_get(gpcc, "time") #"days since 1800-1-1 00:00:00"

time <- as_date(time, origin = ymd("1800-01-01"))
```


I want to restrict this to a lat-lon near BDFFP and time that we have data for BDFFP

Lower-left corner = 02º30'00"S; 60º10'00"W
Upper-right corner = 02º15'00"S; 59º35'00"W

Need to convert to decimal degrees
https://www.rapidtables.com/convert/number/degrees-minutes-seconds-to-degrees.html

lat = -2.25º to -2.5º
lon = -59.583º to -60.167º OR 300.417 to 299.833

```{r}
which.min(abs(lat - -2.5))
which.min(abs(lon - (360-59.583)))
lat[185:186]
latmin <- 185
latmax <- 186

lon[600:602]
lonmin <- 600
lonmax <- 602
# one month
precip <- ncvar_get(gpcc, "precip",
                    start = c(lonmin, latmin, 1161), # c(lon, lat, time)
                    count = c(lonmax - lonmin+1, latmax-latmin+1, 1)  # c(lon, lat, time)
                    ) 
precip
```

rows are lon, columns are lat
lon 600, lat 185 = 172.99


Cool, now I want it over a specific time period

BDFFP data runs from 1987-09-01 to 2012-12-31

```{r}
tstart <- which(time == ymd("1987-09-01"))
tend <- which(time == ymd("2013-02-01"))

precip <- ncvar_get(gpcc, "precip",
                    start = c(lonmin, latmin, tstart), # c(lon, lat, time)
                    count = c(lonmax - lonmin+1, latmax - latmin+1, tend - tstart)  # c(lon, lat, time)
                    ) 
precip[,,1]
```
precip[lon, lat, time]

# Convert into tidy format

Need to smoosh this array into a tidy dataframe with columns `lat`, `lon`, `date`, and `precip`.  I think.

```{r}
nc_close(gpcc)
```

