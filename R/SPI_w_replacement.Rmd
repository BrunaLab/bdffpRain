---
title: "SPI with replacement rules"
author: "Eric R. Scott"
date: "2020-08-12"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(janitor)
library(visdat)
library(tsibble)
library(SPEI)
library(lubridate)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# TODO

- Other options besides mean for replacement with neighboring sites.  See Sanusi et al. 2017.

# Purpose

Generate a continuous daily precip dataset for BDFFP, then aggregate monthly, then use to calculate SPI for each site.

1. First, remove accumulations > 20 mm (arbitrary, but from Liebmann et al 2005)
2. For each site, fill `NA`s with value from neighboring sites > BDFFP average > gridded data product


# Load Data

I'll need the BDFFP cleaned data and the daily gridded data from Liebmann et al.

```{r data, echo=TRUE}
bdffp <- read_csv(here("data_cleaned", "daily_precip.csv")) %>% arrange(site,date)
# sa <- read_csv(here("data_cleaned", "sa_daily_1x1.csv"))
xa <- read_csv(here("data_cleaned", "xavier_daily_0.25x0.25.csv"))
manaus <- read_csv(here("data_cleaned", "manaus_weather.csv"))
```

# Wrangling

## Fill date gaps

```{r}
bdffp <- bdffp %>% as_tsibble(index = date, key = site) %>% fill_gaps() %>% as_tibble()
```

## Remove accumulations
I hate to do it, but I'm just going to toss out accumulated values over 20 mm

```{r}
bdffp1 <- 
  bdffp %>% 
  mutate(precip = ifelse(flag %in% c("U", "A") & precip > 20,
                         NA,
                         precip))
```

## Pivot and add columns

Make a wide data frame.

```{r}
bdffp_wide <-
  bdffp1 %>% 
  select(site, date, precip) %>% 
  pivot_wider(names_from = site, values_from = precip) %>% 
  clean_names() %>% 
  rowwise() %>% 
  mutate(bdffp_mean = mean(
    c(cabo_frio, colosso, dimona, florestal, gaviao, km37, km41, porto_alegre),
    na.rm = TRUE
  ))
vis_miss(bdffp_wide)
```

## First pass: nearby sites

First pass, replace `NA`s with values from near-by sites
Sites are spatially grouped as follows:

1. dimona
2. Porto alegre
3. Colosso, florestal, cabo frio, gaviao
4. km37, km41


```{r}
bdffp_wide1 <-
  bdffp_wide %>% 
  rowwise() %>% 
  mutate(km37_new = ifelse(is.na(km37), km41, km37),
         km41_new = ifelse(is.na(km41), km37, km41)) %>% 
  mutate(colosso_new = ifelse(is.na(colosso), mean(c(florestal, cabo_frio, gaviao), na.rm = TRUE), colosso),
         florestal_new = ifelse(is.na(florestal), mean(c(colosso, cabo_frio, gaviao), na.rm = TRUE), florestal),
         cabo_frio_new = ifelse(is.na(cabo_frio), mean(c(colosso, florestal, gaviao), na.rm = TRUE), cabo_frio),
         gaviao_new = ifelse(is.na(gaviao), mean(c(colosso, florestal, cabo_frio), na.rm = TRUE), gaviao)) %>% 
  select(date,
         cabo_frio = cabo_frio_new,
         colosso = colosso_new,
         dimona,
         florestal = florestal_new,
         gaviao = gaviao_new,
         km37 = km37_new,
         km41 = km41_new,
         porto_alegre,
         bdffp_mean)
 
visdat::vis_miss(bdffp_wide1)
```

## Second pass, BDFFP average

I'm actually questioning whether this makes sense or not.  Let's see how well this aligns with gridded data

```{r}
bdffp_wide2 <-
  bdffp_wide1 %>% 
  rowwise() %>% 
  mutate(across(cabo_frio:porto_alegre,
                ~ifelse(
                  is.na(.),
                  bdffp_mean,
                  .)))
vis_miss(bdffp_wide2)
```


## Third pass, gridded data

```{r}
xa_wide <-
  xa %>% 
  mutate(xa_latlon = paste(lat, lon, sep = ", "), lat = NULL, lon = NULL) %>% 
  pivot_wider(names_from = xa_latlon, values_from = c(precip, eto)) %>%
  clean_names()
```

Match grid cells with sites:

- dimona = 2_375_60_125
- porto_alegre, colosso, gaviao, florestal, cabo_frio = 2_375_59_875
- km37, km41 = 2_375_59_625

```{r}
bdffp_wide3 <-
  left_join(bdffp_wide2, xa_wide) %>% 
  mutate(dimona = ifelse(
    is.na(dimona),
    precip_2_375_60_125,
    dimona
  )) %>% 
  mutate(across(c(cabo_frio:gaviao, porto_alegre),
                ~ifelse(
                  is.na(.x),
                  precip_2_375_59_875,
                  .x
                ))) %>% 
  mutate(across(starts_with("km"),
                ~ifelse(
                  is.na(.x),
                  precip_2_375_59_625,
                  .x
                ))) %>% 
  ungroup()

vis_miss(select(bdffp_wide3, date:porto_alegre))
```

# Aggregate monthly

First, calculate climate balance by subtracting appropriate ETo

##TODO: Is this right?
Aggregate ET0 before calculating SPEI

Also not sure how much I trust the eto values in `xa`.

```{r}
bdffp_mon <-
  bdffp_wide3 %>% 
  mutate(yearmonth = yearmonth(date)) %>% 
  group_by(yearmonth) %>% 
  summarize(across(where(is.numeric), sum))
#remove first and last month as they aren't complete
bdffp_mon1 <-
  bdffp_mon %>% 
  slice(-1, -nrow(bdffp_mon))
```

  
```{r}
bdffp_prep <-
  bdffp_mon1 %>% 
  mutate(dimona.cb = dimona - eto_2_375_60_125) %>% 
  mutate(across(starts_with("km"),
                ~.x - eto_2_375_59_625, .names = "{col}.cb")) %>% 
  mutate(across(c(porto_alegre, colosso, cabo_frio, florestal, gaviao),
                ~.x - eto_2_375_59_875, .names = "{col}.cb")) %>% 
  rename_with(~paste0(.,".precip"),
              c(dimona, porto_alegre, colosso, cabo_frio, florestal, gaviao, km41, km37)) %>% 
  select(yearmonth, ends_with(".precip"), ends_with(".cb"))
```

## Calculate SPI and SPEI

- spi <= -2.0 ~ "extreme",
- -2.0 < spi <= -1.5  ~ "severe",
- -1.5 < spi <= -1.0 ~ "moderate",
- -1.0 < spi <= 0 ~ "mild"

```{r}
spi_wide <- 
  bdffp_prep %>% 
  mutate(across(ends_with(".precip"),
                ~as.numeric(spi(.x, scale = 3)$fitted),
                .names = "{str_remove(col, '.precip')}.spi")) %>% 
  mutate(across(ends_with(".cb"),
                ~as.numeric(spei(.x, scale = 3)$fitted),
                .names = "{str_remove(col, '.cb')}.spei"))

spi_out <-
  spi_wide %>% 
  pivot_longer(-yearmonth, names_to = c("site", "var"), names_sep = "\\.") %>% 
  filter(var != "cb") %>% 
  pivot_wider(names_from = var) %>% 
  mutate(date = as_date(yearmonth)) %>% 
  select(date, site, tot_precip = precip, spi, spei) %>% 
  arrange(site, date)
```


```{r}
ggplot(spi_out, aes(x = date, y = spi, color = site)) +
  geom_line() +
  geom_hline(aes(yintercept = -2), color = "red") +
  geom_hline(aes(yintercept = -1.5), color = "darkorange") +
  geom_hline(aes(yintercept = -1), color = "goldenrod") +
  facet_wrap(~year(date), scales = "free_x")
```


```{r}
ggplot(spi_out, aes(x = date, y = spei, color = site)) +
  geom_line() +
  geom_hline(aes(yintercept = -2), color = "red") +
  geom_hline(aes(yintercept = -1.5), color = "darkorange") +
  geom_hline(aes(yintercept = -1), color = "goldenrod") +
  facet_wrap(~year(date), scales = "free_x")
```

What happened in August 2008 at the km sites???
```{r}
ggplot(spi_out %>% filter(year(date) == 2008),
       aes(x = date, y = spei, color = site)) +
  geom_line() +
  geom_hline(aes(yintercept = -2), color = "red") +
  geom_hline(aes(yintercept = -1.5), color = "darkorange") +
  geom_hline(aes(yintercept = -1), color = "goldenrod")
```


```{r}
spi_out %>% filter(year(date) == 2008, site == "km37")
bdffp_prep %>% filter(yearmonth == yearmonth("2008 Aug"))
xa %>% 
  filter(between(date, ymd("2008-08-01"), ymd("2008-08-31"))) %>% 
  arrange(date,lon) %>% 
  group_by(lon) %>% 
  summarise(sum(eto))
```

I guess they just got a lot of rain and had a slightly lower ET0.

# Save data

## Daily

```{r}
daily_replacement <- 
  bdffp_wide3 %>%
  select(date:porto_alegre) %>% 
  pivot_longer(-date, names_to = "site", values_to = "precip") %>% 
  arrange(site, date)
```

```{r}
write_csv(daily_replacement, here("data_cleaned", "daily_replacement.csv"))
```

## Monthly w/ SPI & SPEI


```{r}
write_csv(spi_out, here("data_cleaned", "mon_precip_spi_repl.csv"))
```

